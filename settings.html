<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="view-transition" content="same-origin">
    <title>Nexura | Paramètres</title>
    <script src="protect.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="room.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SaaS Infrastructure -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="ui.js"></script>
    <style>
        .settings-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }

        .settings-section h2 {
            font-size: 1.1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .setting-info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="password"],
        select {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            outline: none;
            font-family: inherit;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        /* Configuration Tabs */
        .tabs-header {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .tab-item {
            padding: 0.75rem 0.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            transition: all 0.3s;
        }

        .tab-item.active {
            color: var(--accent-color);
        }

        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-color);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .scan-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

        .scan-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .scan-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .scan-item-info {
            flex: 1;
        }

        .scan-item-info h4 {
            font-size: 0.9rem;
            margin-bottom: 0.1rem;
        }

        .scan-item-info p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Switch Toggle Style */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="nav-links" style="margin-top: 1rem;">
                <a href="index.html" class="nav-item">
                    <i data-lucide="layout-dashboard" class="nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="categories.html" class="nav-item">
                    <i data-lucide="layers" class="nav-icon"></i>
                    <span class="nav-text">Catégories</span>
                </a>
                <a href="settings.html" class="nav-item active">
                    <i data-lucide="settings" class="nav-icon"></i>
                    <span class="nav-text">Paramètres</span>
                </a>
                <a href="batteries.html" class="nav-item">
                    <i data-lucide="battery" class="nav-icon"></i>
                    <span class="nav-text">Batteries</span>
                </a>
                <a href="cameras.html" class="nav-item">
                    <i data-lucide="video" class="nav-icon"></i>
                    <span class="nav-text">Caméras</span>
                </a>

                <a href="#" class="nav-item" id="navAccount" onclick="openAuthModal()">
                    <i data-lucide="user" class="nav-icon"></i>
                    <span class="nav-text">Mon Compte</span>
                </a>
            </nav>

            <div style="margin-top: auto; padding: 1rem 0;">
                <button id="toggleSidebar" class="nav-item"
                    style="border: none; background: transparent; width: 100%; cursor: pointer;">
                    <i data-lucide="chevron-left" class="nav-icon" id="sidebarIcon"></i>
                    <span class="nav-text">Réduire</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>Paramètres</h1>
            </header>


            <!-- Personnalisation Section -->
            <div class="settings-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Personnalisation</h2>
                </div>
                <div class="setting-item" id="themeSettingItem">
                    <div class="setting-info">
                        <h3>Thème visuel</h3>
                        <p id="themeSubtext">Changez l'apparence globale de l'interface</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <select id="themeSelector" onchange="handleThemeChange()" style="min-width: 150px;">
                            <option value="nexura">Nexura (Ultra)</option>
                            <option value="default">Nexura (Sombre)</option>
                            <option value="modern">Indigo Moderne (Premium)</option>
                            <option value="light">Clarté (Lumineux)</option>
                            <option value="forest">Forêt sauvage (Vert)</option>
                            <option value="ocean">Abysses (Bleu)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Expérience Visuelle Section -->
            <div class="settings-section">
                <h2>Expérience Visuelle</h2>

                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Effet Frost & Focus</h3>
                        <p>Estompe discrètement les capteurs et appareils inactifs pour porter votre attention sur
                            l'essentiel.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="frostEffectToggle" onchange="saveVisualSettings()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Flux d'Énergie Dynamique</h3>
                        <p>Visualise la circulation de l'énergie en temps réel depuis votre source de consommation vers
                            vos appareils.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="energyFlowToggle" onchange="saveVisualSettings()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Fond d'écran Dynamique</h3>
                        <p>Adapte l'ambiance lumineuse et les couleurs du dashboard selon le cycle naturel du jour et de
                            la nuit.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dynamicBgToggle" onchange="saveVisualSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Support & Donation Section -->
            <div class="settings-section">
                <h2>Soutenir le projet</h2>
                <div class="donation-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h3 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                Buy Me a Coffee <span class="donation-badge">Supporteur</span>
                            </h3>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
                                Nexura est un projet gratuit et indépendant. Si vous appréciez mon travail et
                                souhaitez m'aider à payer les serveurs ou simplement m'offrir un café, votre soutien est
                                grandement apprécié ! ☕
                            </p>
                        </div>
                        <div style="background: rgba(255, 221, 0, 0.1); padding: 12px; border-radius: 12px;">
                            <i data-lucide="heart" style="color: #FFDD00; width: 24px; height: 24px;"></i>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <a href="https://www.buymeacoffee.com/SimonV" target="_blank" class="bmc-button">
                            <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="BMC logo"
                                class="bmc-icon">
                            Offrir un café
                        </a>
                    </div>
                </div>
            </div>

            <!-- Server Configuration Section -->
            <div class="settings-section">
                <div class="tabs-header">
                    <div class="tab-item active" onclick="switchTab('ha')">Home Assistant</div>
                    <div class="tab-item" onclick="switchTab('tuya')">TUYA</div>
                    <div class="tab-item" onclick="switchTab('xiaomi')">XIAOMI</div>
                </div>

                <!-- HA Tab Pane -->
                <div id="ha-tab" class="tab-pane active">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <h3>URL de l'instance</h3>
                                <button onclick="openHAHelpModal()"
                                    style="background:none; border:none; padding:0; cursor:pointer; color:var(--accent-color); display:flex; align-items:center;">
                                    <i data-lucide="help-circle" style="width: 14px; height: 14px;"></i>
                                </button>
                            </div>
                            <p>Ex: http://192.168.1.100:8123</p>
                        </div>
                        <input type="text" id="haUrl" placeholder="http://homeassistant.local:8123">
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Jeton d'accès (Long-lived Token)</h3>
                            <p>Généré dans votre profil Home Assistant</p>
                        </div>
                        <input type="password" id="haToken" placeholder="votre_jeton_ici">
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Entité de Consommation</h3>
                            <p>Ex: sensor.energy_consumption</p>
                        </div>
                        <input type="text" id="haEntityEnergy" placeholder="sensor.mon_compteur_energie">
                    </div>
                    <div class="setting-item" style="border-bottom: none; padding-bottom: 0;">
                        <div class="setting-info">
                            <h3>Configuration</h3>
                            <p>Enregistrer et tester la connexion</p>
                        </div>
                        <button class="filter-btn active" style="width: 100%;" id="testConnBtn">Enregistrer &
                            Tester</button>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 1rem;">
                        <i data-lucide="info" style="width: 12px; vertical-align: middle;"></i>
                        Note : Assurez-vous d'avoir autorisé l'origine dans votre `configuration.yaml` de Home Assistant
                        (CORS).
                    </p>
                </div>

                <!-- Tuya Tab Pane -->
                <div id="tuya-tab" class="tab-pane">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Access ID (Client ID)</h3>
                            <p>Trouvé dans Tuya IoT Cloud > Cloud Project</p>
                        </div>
                        <input type="text" id="tuyaClientId" placeholder="votre_access_id">
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Access Secret</h3>
                            <p>Le secret associé à votre projet Cloud</p>
                        </div>
                        <input type="password" id="tuyaSecret" placeholder="votre_access_secret">
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Région</h3>
                            <p>Ex: eu, us, cn (eu = Europe)</p>
                        </div>
                        <select id="tuyaRegion" style="width: 200px;">
                            <option value="eu">Europe (Western)</option>
                            <option value="us">America (Western)</option>
                            <option value="cn">China</option>
                            <option value="in">India</option>
                        </select>
                    </div>
                    <div class="setting-item" style="border-bottom: none; padding-bottom: 0;">
                        <div class="setting-info">
                            <h3>Configuration Tuya</h3>
                            <p>Enregistrer et synchroniser les appareils</p>
                        </div>
                        <button class="filter-btn active" style="width: 100%;" id="saveTuyaBtn">Sauvegarder</button>
                    </div>
                </div>

                <!-- Xiaomi Tab Pane -->
                <div id="xiaomi-tab" class="tab-pane">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Identifiant Mi Home</h3>
                            <p>Email ou ID de compte Xiaomi</p>
                        </div>
                        <input type="text" id="xiaomiUser" placeholder="votre@email.com">
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Mot de passe</h3>
                            <p>Le mot de passe de votre compte Xiaomi</p>
                        </div>
                        <input type="password" id="xiaomiPassword" placeholder="votre_mot_de_passe">
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Région</h3>
                            <p>Serveur sur lequel vos appareils sont enregistrés</p>
                        </div>
                        <select id="xiaomiRegion" style="width: 200px;">
                            <option value="de">Europe (Francfort)</option>
                            <option value="cn">China (Mainland)</option>
                            <option value="sg">Singapore</option>
                            <option value="us">United States</option>
                            <option value="ru">Russia</option>
                        </select>
                    </div>
                    <div class="setting-item" style="border-bottom: none; padding-bottom: 0;">
                        <div class="setting-info">
                            <h3>Configuration Xiaomi</h3>
                            <p>Enregistrer et synchroniser les appareils</p>
                        </div>
                        <button class="filter-btn active" style="width: 100%;" id="saveXiaomiBtn">Sauvegarder</button>
                    </div>
                </div>
            </div>

            <!-- Room Management Section -->
            <div class="settings-section">
                <h2>Gestion des Pièces</h2>
                <div
                    style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; flex: 1;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary);">Nom de la pièce</label>
                            <input type="text" id="roomName" placeholder="Ex: Salon, Cuisine...">
                        </div>
                        <button class="filter-btn active" id="addRoomBtn"
                            style="height: 38px; border-radius: 8px;">Ajouter</button>
                    </div>
                </div>
                <div id="roomListContainer">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Entity Management Section -->
            <div class="settings-section">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border);">
                    <h2 style="margin-bottom: 0; border-bottom: none;">Gestion des Entités</h2>
                    <button class="filter-btn" id="openScannerBtn"
                        style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="search" style="width: 14px;"></i> Scanner
                    </button>
                </div>

                <!-- Add Entity Form -->
                <div
                    style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 2rem;">
                    <h3 style="font-size: 0.9rem; margin-bottom: 1rem; color: var(--text-primary);">Ajouter une
                        entité</h3>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; align-items: flex-end;">
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary);">Nom à afficher</label>
                            <input type="text" id="entityName" placeholder="Ex: Plafonnier Salon">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary);">Type</label>
                            <select id="entityType">
                                <option value="light">Lumière</option>
                                <option value="shutter">Volet</option>
                                <option value="porte">Porte</option>
                                <option value="fenetre">Fenêtre</option>
                                <option value="sensor">Capteur</option>
                                <option value="temperature">Température</option>
                                <option value="humidity">Humidité</option>
                                <option value="switch">Prise / Interrupteur</option>
                                <option value="climate">Climatisation</option>
                                <option value="camera">Caméra de surveillance</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary);">Pièce</label>
                            <select id="entityRoom" class="room-selector">
                                <option value="">Non classé</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary);">Variante</label>
                            <select id="entityVariant">
                                <option value="">Standard</option>
                                <option value="dimmer">Variateur (Lumière)</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="font-size: 0.75rem; color: var(--text-secondary);">Entité ID (HA)</label>
                            <input type="text" id="entityHAId" placeholder="Ex: light.salon_main">
                        </div>
                        <button class="filter-btn active" id="addEntityBtn"
                            style="height: 38px; border-radius: 8px;">Ajouter</button>
                    </div>
                </div>

                <!-- Entity List -->
                <div id="entityListContainer">
                    <!-- Will be populated by JS -->
                </div>
            </div>

    </div>
    </main>
    </div>

    <!-- Scanner Modal -->
    <div class="modal-overlay" id="scannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="font-size: 1.2rem; margin: 0;">Scanner Home Assistant</h2>
                <button id="closeScannerBtn"
                    style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem; position: relative;">
                    <i data-lucide="search"
                        style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-secondary);"></i>
                    <input type="text" id="scanSearchInput" placeholder="Rechercher une entité..."
                        style="width: 100%; padding-left: 35px; height: 38px;">
                </div>
                <div id="scannerResults">
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Appuyez sur "Lancer le
                        scan" pour voir vos entités.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="filter-btn" id="startScanBtn">Lancer le scan</button>
                <button class="filter-btn active" id="importBtn" style="display: none;">Importer la sélection</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content" style="max-width: 450px; padding: 0;">
            <div
                style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="authTitle" style="margin: 0; font-size: 1.2rem;">Connexion Cloud</h2>
                <button onclick="closeAuthModal()"
                    style="background: none; border: none; color: var(--text-secondary); cursor: pointer;"><i
                        data-lucide="x"></i></button>
            </div>

            <div style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                <!-- Main Benefit Highlight -->
                <div
                    style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center;">
                    <div
                        style="background: #10b981; min-width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                        <i data-lucide="shield-check" style="width: 20px;"></i>
                    </div>
                    <div>
                        <h4 style="margin: 0; font-size: 0.85rem; color: #10b981;">Données Privées & Sécurisées</h4>
                        <p style="margin: 0; font-size: 0.75rem; color: var(--text-secondary);">En auto-hébergeant votre
                            base Supabase, vous êtes l'unique propriétaire de vos données.</p>
                    </div>
                </div>


                <!-- Registration / Login Form -->
                <form id="authForm" style="display: flex; flex-direction: column; gap: 1.25rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Email</label>
                        <input type="email" id="authEmail" required placeholder="votre@email.com" style="width: 100%;">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Mot de passe</label>
                        <input type="password" id="authPassword" required placeholder="••••••••" style="width: 100%;">
                    </div>
                    <button type="submit" class="filter-btn active"
                        style="width: 100%; height: 42px; font-weight: 600;">Se connecter</button>
                </form>

                <div style="margin-top: 1.5rem; text-align: center; font-size: 0.85rem;">
                    <span style="color: var(--text-secondary);" id="authToggleText">Pas encore de compte ?</span>
                    <a href="#" onclick="toggleAuthMode()" id="authToggleBtn"
                        style="color: var(--accent-color); text-decoration: none; font-weight: 600; margin-left: 0.5rem;">S'inscrire</a>
                </div>
            </div>
        </div>
    </div>


    <script src="nexura-auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadHASettings();
            loadTuyaSettings();
            loadXiaomiSettings();
            loadVisualSettings();
        });

        function saveVisualSettings() {
            localStorage.setItem('ef_frost_enabled', document.getElementById('frostEffectToggle').checked);
            localStorage.setItem('ef_energy_enabled', document.getElementById('energyFlowToggle').checked);
            localStorage.setItem('ef_ambiance_enabled', document.getElementById('dynamicBgToggle').checked);
            console.log("Visual Settings saved");
        }

        function loadVisualSettings() {
            document.getElementById('frostEffectToggle').checked = localStorage.getItem('ef_frost_enabled') !== 'false';
            document.getElementById('energyFlowToggle').checked = localStorage.getItem('ef_energy_enabled') !== 'false';
            document.getElementById('dynamicBgToggle').checked = localStorage.getItem('ef_ambiance_enabled') !== 'false';
        }
        function switchTab(tab) {
            // Update Tab Items
            document.querySelectorAll('.tab-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                if ((tab === 'ha' && text.includes('assistant')) || (tab === 'tuya' && text.includes('tuya')) || (tab === 'xiaomi' && text.includes('xiaomi'))) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            // Update Tab Panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const sidebarIcon = document.getElementById('sidebarIcon');

        // Initial icon and text state based on persistence
        if (sidebar.classList.contains('collapsed')) {
            sidebarIcon.setAttribute('data-lucide', 'chevron-right');
        }

        toggleBtn.addEventListener('click', () => {
            const isCollapsed = sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebar_collapsed', isCollapsed);
            sidebarIcon.setAttribute('data-lucide', isCollapsed ? 'chevron-right' : 'chevron-left');
            lucide.createIcons();
        });

        // --- HA Persistence & Test Logic ---
        const haUrlInput = document.getElementById('haUrl');
        const haTokenInput = document.getElementById('haToken');
        const haEntityInput = document.getElementById('haEntityEnergy');
        const testBtn = document.getElementById('testConnBtn');

        // Function to save all fields to localStorage
        function saveHASettings() {
            localStorage.setItem('haUrl', haUrlInput.value.trim().replace(/\/$/, ""));
            localStorage.setItem('haToken', haTokenInput.value.trim());
            localStorage.setItem('haEntityEnergy', haEntityInput.value.trim());
            console.log("HA Settings saved to localStorage");
        }

        // Load settings
        function loadHASettings() {
            haUrlInput.value = localStorage.getItem('haUrl') || '';
            haTokenInput.value = localStorage.getItem('haToken') || '';
            haEntityInput.value = localStorage.getItem('haEntityEnergy') || '';
        }

        // Save immediately when user types
        [haUrlInput, haTokenInput, haEntityInput].forEach(input => {
            if (input) {
                input.addEventListener('input', saveHASettings);
            }
        });

        // Initialize on load
        loadHASettings();

        // --- Tuya Persistence ---
        const tuyaClientIdInput = document.getElementById('tuyaClientId');
        const tuyaSecretInput = document.getElementById('tuyaSecret');
        const tuyaRegionInput = document.getElementById('tuyaRegion');
        const saveTuyaBtn = document.getElementById('saveTuyaBtn');

        function saveTuyaSettings() {
            localStorage.setItem('tuyaClientId', tuyaClientIdInput.value.trim());
            localStorage.setItem('tuyaSecret', tuyaSecretInput.value.trim());
            localStorage.setItem('tuyaRegion', tuyaRegionInput.value);
            console.log("Tuya Settings saved to localStorage");
        }

        function loadTuyaSettings() {
            tuyaClientIdInput.value = localStorage.getItem('tuyaClientId') || '';
            tuyaSecretInput.value = localStorage.getItem('tuyaSecret') || '';
            tuyaRegionInput.value = localStorage.getItem('tuyaRegion') || 'eu';
        }

        [tuyaClientIdInput, tuyaSecretInput, tuyaRegionInput].forEach(input => {
            if (input) input.addEventListener('input', saveTuyaSettings);
        });

        loadTuyaSettings();

        if (saveTuyaBtn) {
            saveTuyaBtn.addEventListener('click', async () => {
                saveTuyaSettings();
                saveTuyaBtn.textContent = 'Enregistré ✓';
                saveTuyaBtn.style.backgroundColor = '#10b981';

                // Sync to cloud
                if (window.syncToCloud) {
                    const success = await window.syncToCloud();
                    if (!success) {
                        saveTuyaBtn.textContent = 'Échec Synchronisation Cloud';
                        saveTuyaBtn.style.backgroundColor = '#ef4444';
                    }
                }

                setTimeout(() => {
                    saveTuyaBtn.textContent = 'Sauvegarder';
                    saveTuyaBtn.style.backgroundColor = 'var(--accent-color)';
                }, 3000);
            });
        }

        // --- Xiaomi Persistence ---
        const xiaomiUserInput = document.getElementById('xiaomiUser');
        const xiaomiPasswordInput = document.getElementById('xiaomiPassword');
        const xiaomiRegionInput = document.getElementById('xiaomiRegion');
        const saveXiaomiBtn = document.getElementById('saveXiaomiBtn');

        function saveXiaomiSettings() {
            localStorage.setItem('xiaomiUser', xiaomiUserInput.value.trim());
            localStorage.setItem('xiaomiPassword', xiaomiPasswordInput.value.trim());
            localStorage.setItem('xiaomiRegion', xiaomiRegionInput.value);
            console.log("Xiaomi Settings saved to localStorage");
        }

        function loadXiaomiSettings() {
            xiaomiUserInput.value = localStorage.getItem('xiaomiUser') || '';
            xiaomiPasswordInput.value = localStorage.getItem('xiaomiPassword') || '';
            xiaomiRegionInput.value = localStorage.getItem('xiaomiRegion') || 'de';
        }

        [xiaomiUserInput, xiaomiPasswordInput, xiaomiRegionInput].forEach(input => {
            if (input) input.addEventListener('input', saveXiaomiSettings);
        });

        loadXiaomiSettings();

        if (saveXiaomiBtn) {
            saveXiaomiBtn.addEventListener('click', async () => {
                saveXiaomiSettings();
                saveXiaomiBtn.textContent = 'Enregistré ✓';
                saveXiaomiBtn.style.backgroundColor = '#10b981';

                if (window.syncToCloud) {
                    const success = await window.syncToCloud();
                    if (!success) {
                        saveXiaomiBtn.textContent = 'Échec Synchronisation Cloud';
                        saveXiaomiBtn.style.backgroundColor = '#ef4444';
                    }
                }

                setTimeout(() => {
                    saveXiaomiBtn.textContent = 'Sauvegarder';
                    saveXiaomiBtn.style.backgroundColor = 'var(--accent-color)';
                }, 3000);
            });
        }

        // Connection Test
        if (testBtn) {
            testBtn.addEventListener('click', async () => {
                // Save one last time to be sure
                saveHASettings();

                // Sanitize URL and Token
                const url = haUrlInput.value.trim().replace(/\/$/, "");
                const token = haTokenInput.value.trim();
                const entity = haEntityInput.value.trim();

                if (!url || !token) {
                    testBtn.textContent = 'Champs requis !';
                    testBtn.style.backgroundColor = '#f59e0b';
                    setTimeout(() => {
                        testBtn.textContent = 'Enregistrer & Tester';
                        testBtn.style.backgroundColor = 'var(--surface-color)';
                    }, 2000);
                    return;
                }

                testBtn.textContent = 'Connexion...';
                testBtn.style.backgroundColor = 'var(--accent-color)';

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000);

                    // Pre-check for Mixed Content if Nexura is HTTPS
                    if (window.location.protocol === 'https:' && url.startsWith('http:')) {
                        console.warn("Potential Mixed Content issue detected");
                    }

                    const endpoint = entity ? `${url}/api/states/${entity}` : `${url}/api/config`;

                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const data = await response.json();
                        const statusLabel = (entity && data.state) ? `Connecté ✓ (${data.state})` : 'Instance Connectée ✓';
                        testBtn.textContent = statusLabel;
                        testBtn.style.backgroundColor = '#10b981';
                        testBtn.style.borderColor = '#10b981';

                        // Sync to cloud if logged in
                        if (window.syncToCloud) {
                            console.log("Triggering cloud sync after successful HA test...");
                            window.syncToCloud();
                        }
                    } else {
                        let errorMsg = `Erreur ${response.status}`;
                        if (response.status === 401) errorMsg = 'Clé API/Jeton invalide';
                        if (response.status === 403) errorMsg = 'CORS ou Accès refusé';
                        if (response.status === 404) errorMsg = 'Instance introuvable (404)';

                        testBtn.textContent = errorMsg;
                        testBtn.style.backgroundColor = '#ef4444';
                        testBtn.style.borderColor = '#ef4444';
                    }
                } catch (err) {
                    console.error("Connection failed details:", err);
                    let finalError = 'Échec de connexion';

                    if (err.name === 'AbortError') {
                        finalError = 'Timeout (Réseau local ?)';
                    } else if (err.message.includes('fetch') || err instanceof TypeError) {
                        // Often caused by CORS or Mixed Content (HTTPS -> HTTP)
                        if (window.location.protocol === 'https:' && url.startsWith('http:')) {
                            finalError = 'Bloqué : HTTPS vs HTTP';
                        } else {
                            finalError = 'CORS / Réseau bloqué';
                        }
                    }

                    testBtn.textContent = finalError;
                    testBtn.style.backgroundColor = '#ef4444';
                    testBtn.style.borderColor = '#ef4444';
                }

                setTimeout(() => {
                    testBtn.textContent = 'Enregistrer & Tester';
                    testBtn.style.backgroundColor = 'var(--surface-color)';
                    testBtn.style.borderColor = 'var(--glass-border)';
                }, 4000);
            });
        }

        // --- Helpers ---
        function slugify(text) {
            return text.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
        }

        // --- Room Management ---
        let rooms = JSON.parse(localStorage.getItem('domotique_rooms')) || [];
        const roomListContainer = document.getElementById('roomListContainer');
        const roomNameInput = document.getElementById('roomName');
        const addRoomBtn = document.getElementById('addRoomBtn');

        function renderRooms() {
            if (!roomListContainer) return;
            roomListContainer.innerHTML = '';
            if (rooms.length === 0) {
                roomListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">Aucune pièce créée.</p>';
            }

            // Sort rooms alphabetically
            const sortedRooms = [...rooms].sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

            sortedRooms.forEach(room => {
                const item = document.createElement('div');
                item.className = 'setting-item';
                item.innerHTML = `
            <div class="setting-info">
                <h3>${room.name}</h3>
                <p>ID: ${room.id}</p>
            </div>
            <button class="filter-btn" style="border: none; color: #ef4444; background: transparent; padding: 0.5rem;"
                onclick="deleteRoom('${room.id}')">
                <i data-lucide="trash-2" style="width: 18px;"></i>
            </button>
            `;
                roomListContainer.appendChild(item);
            });
            lucide.createIcons();
            updateRoomSelectors();
        }

        window.deleteRoom = function (id) {
            rooms = rooms.filter(r => r.id !== id);
            localStorage.setItem('domotique_rooms', JSON.stringify(rooms));
            // Unassign entities
            entities = entities.map(e => e.roomId === id ? { ...e, roomId: null } : e);
            localStorage.setItem('domotique_entities', JSON.stringify(entities));
            renderRooms();
            renderEntities();
            if (window.syncToCloud) window.syncToCloud();
        };

        if (addRoomBtn) {
            addRoomBtn.addEventListener('click', () => {
                const name = roomNameInput.value.trim();
                if (!name) return;
                const id = slugify(name);
                if (rooms.some(r => r.id === id)) {
                    alert("Cette pièce existe déjà.");
                    return;
                }
                rooms.push({ id, name });
                localStorage.setItem('domotique_rooms', JSON.stringify(rooms));
                roomNameInput.value = '';
                renderRooms();
                if (window.syncToCloud) window.syncToCloud();
            });
        }

        function updateRoomSelectors() {
            const selectors = document.querySelectorAll('.room-selector');
            selectors.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">Non classé</option>';

                // Sort rooms for dropdown
                const sortedRooms = [...rooms].sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

                sortedRooms.forEach(room => {
                    const opt = document.createElement('option');
                    opt.value = room.id;
                    opt.textContent = room.name;
                    select.appendChild(opt);
                });
                select.value = currentVal;
            });
        }

        // --- Dynamic Entity Management ---
        let entities = JSON.parse(localStorage.getItem('domotique_entities')) || [];
        const entityNameInput = document.getElementById('entityName');
        const entityTypeInput = document.getElementById('entityType');
        const entityRoomInput = document.getElementById('entityRoom');
        const entityHAIdInput = document.getElementById('entityHAId');
        const addEntityBtn = document.getElementById('addEntityBtn');
        const entityListContainer = document.getElementById('entityListContainer');

        const typeLabels = {
            light: 'Lumière',
            shutter: 'Volet',
            porte: 'Porte',
            fenetre: 'Fenêtre',
            sensor: 'Capteur',
            temperature: 'Température',
            humidity: 'Humidité',
            switch: 'Prise / Interrupteur',
            climate: 'Climatisation',
            binary_sensor: 'Détecteur',
            camera: 'Caméra'
        };

        function renderEntities() {
            entityListContainer.innerHTML = '';

            // Sort entities by type, then by name
            const sortedEntities = [...entities].sort((a, b) => {
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                return a.name.localeCompare(b.name);
            });

            if (sortedEntities.length === 0) {
                entityListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Aucune entité configurée.</p>';
                return;
            }

            let currentType = null;

            sortedEntities.forEach((entity, index) => {
                // Add header for type if it changes
                if (entity.type !== currentType) {
                    currentType = entity.type;
                    const typeHeader = document.createElement('h3');
                    typeHeader.style.cssText = 'font-size: 0.8rem; color: var(--accent-color); text-transform: uppercase; letter-spacing: 1px; margin: 1.5rem 0 0.75rem 0;';
                    typeHeader.textContent = typeLabels[currentType];
                    entityListContainer.appendChild(typeHeader);
                }

                const roomName = rooms.find(r => r.id === entity.roomId)?.name || 'Non classé';

                const item = document.createElement('div');
                item.className = 'setting-item';
                let variantOptions = '<option value="">Standard</option>';
                if (entity.type === 'light') {
                    variantOptions += `<option value="dimmer" ${entity.variant === 'dimmer' ? 'selected' : ''}>Variateur</option>`;
                } else if (entity.type === 'binary_sensor') {
                    variantOptions += `
                        <option value="presence" ${entity.variant === 'presence' ? 'selected' : ''}>Présence</option>
                        <option value="door" ${entity.variant === 'door' ? 'selected' : ''}>Porte</option>
                        <option value="window" ${entity.variant === 'window' ? 'selected' : ''}>Fenêtre</option>
                    `;
                } else if (entity.type === 'camera') {
                    variantOptions += `
                        <option value="proxy" ${entity.variant === 'proxy' || !entity.variant ? 'selected' : ''}>Snapshot (Auto)</option>
                    `;
                }

                item.innerHTML = `
            <div class="setting-info">
                <h3>${entity.name}</h3>
                <p style="font-size: 0.75rem; color: var(--accent-color);">${roomName}</p>
                <p>${entity.haId}</p>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <select class="type-selector" onchange="updateEntityType('${entity.haId}', this.value)"
                    style="font-size: 0.75rem; padding: 0.25rem;">
                    ${Object.entries(typeLabels).map(([val, lbl]) => `<option value="${val}" ${val === entity.type ? 'selected' : ''}>${lbl}</option>`).join('')}
                </select>
                <select class="variant-selector" onchange="updateVariant('${entity.haId}', this.value)"
                    style="font-size: 0.75rem; padding: 0.25rem;">
                    ${variantOptions}
                </select>
                <select class="room-selector" onchange="assignRoom('${entity.haId}', this.value)"
                    style="font-size: 0.75rem; padding: 0.25rem;">
                    <option value="">Pièce...</option>
                    ${rooms.map(r => `<option value="${r.id}" ${r.id === entity.roomId ? 'selected' : ''}>${r.name}</option>`).join('')}
                </select>
                <button class="filter-btn"
                    style="border: none; color: #ef4444; background: transparent; padding: 0.5rem;"
                    onclick="deleteEntity('${entity.haId}')">
                    <i data-lucide="trash-2" style="width: 18px;"></i>
                </button>
            </div>
            `;
                entityListContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        window.updateEntityType = function (haId, newType) {
            entities = entities.map(e => e.haId === haId ? { ...e, type: newType } : e);
            localStorage.setItem('domotique_entities', JSON.stringify(entities));
            renderEntities();
            if (window.syncToCloud) window.syncToCloud();
        };

        window.assignRoom = function (haId, roomId) {
            entities = entities.map(e => e.haId === haId ? { ...e, roomId: roomId || null } : e);
            localStorage.setItem('domotique_entities', JSON.stringify(entities));
            renderEntities();
            if (window.syncToCloud) window.syncToCloud();
        };

        window.updateVariant = function (haId, variant) {
            entities = entities.map(e => e.haId === haId ? { ...e, variant: variant || null } : e);
            localStorage.setItem('domotique_entities', JSON.stringify(entities));
            renderEntities();
            if (window.syncToCloud) window.syncToCloud();
        };

        window.deleteEntity = function (haId) {
            entities = entities.filter(e => e.haId !== haId);
            localStorage.setItem('domotique_entities', JSON.stringify(entities));
            renderEntities();
            if (window.syncToCloud) window.syncToCloud();
        };

        addEntityBtn.addEventListener('click', () => {
            if (!window.isFeatureAllowed('entities', entities.length)) {
                alert("Limite atteinte : Le plan Gratuit est limité à 10 entités. Passez à l'offre Pro pour un nombre illimité!");
                return;
            }
            const name = entityNameInput.value.trim();
            const type = entityTypeInput.value;
            const roomId = entityRoomInput.value;
            const haId = entityHAIdInput.value.trim();

            if (!name || !haId) {
                alert("Veuillez remplir tous les champs.");
                return;
            }

            // Avoid duplicates
            if (entities.some(e => e.haId === haId)) {
                alert("Cette entité existe déjà.");
                return;
            }

            const variant = document.getElementById('entityVariant').value || null;
            entities.push({ name, type, haId, roomId: roomId || null, variant });
            localStorage.setItem('domotique_entities', JSON.stringify(entities));

            // Reset form
            entityNameInput.value = '';
            entityHAIdInput.value = '';

            renderEntities();
            if (window.syncToCloud) window.syncToCloud();
        });

        // --- Theme Logic ---
        function initThemeUI() {
            const selector = document.getElementById('themeSelector');

            const currentTheme = localStorage.getItem('sv_theme') || 'default';
            if (selector) {
                selector.value = currentTheme;
                selector.disabled = false;
            }
        }

        function handleThemeChange() {
            const selector = document.getElementById('themeSelector');
            if (!selector) return;

            const theme = selector.value;
            if (window.applyTheme) {
                window.applyTheme(theme);
                if (window.syncToCloud) window.syncToCloud();
            }
        }

        // Call init after everything is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initThemeUI, 500); // Small delay to let svauth.js load tier
        });

        window.addEventListener('dataSynced', initThemeUI);

        // Initial render
        renderRooms();
        renderEntities();
        initThemeUI(); // Call initThemeUI here as well, as it's part of initial setup.

        // Refresh on storage changes (e.g. from cloud sync in another tab or auth.js)
        window.addEventListener('storage', (e) => {
            if (e.key === 'domotique_rooms' || e.key === 'domotique_entities') {
                rooms = JSON.parse(localStorage.getItem('domotique_rooms')) || [];
                entities = JSON.parse(localStorage.getItem('domotique_entities')) || [];
                renderRooms();
                renderEntities();
            }
        });

        // Custom event for same-tab updates from auth.js sync
        window.addEventListener('dataSynced', () => {
            rooms = JSON.parse(localStorage.getItem('domotique_rooms')) || [];
            entities = JSON.parse(localStorage.getItem('domotique_entities')) || [];
            renderRooms();
            renderEntities();
        });

        // --- Scanner Logic ---
        const scannerModal = document.getElementById('scannerModal');
        const openScannerBtn = document.getElementById('openScannerBtn');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        const startScanBtn = document.getElementById('startScanBtn');
        const scannerResults = document.getElementById('scannerResults');
        const importBtn = document.getElementById('importBtn');

        let scannedEntities = [];

        openScannerBtn.addEventListener('click', () => {
            scannerModal.style.display = 'flex';
            scannerModal.offsetHeight; // reflow
            scannerModal.classList.add('visible');
            lucide.createIcons(); // Ensure icons in modal are rendered
        });

        closeScannerBtn.addEventListener('click', () => {
            scannerModal.classList.remove('visible');
            setTimeout(() => {
                scannerModal.style.display = 'none';
            }, 300);
        });

        window.onclick = (event) => {
            if (event.target == scannerModal) {
                scannerModal.classList.remove('visible');
                setTimeout(() => scannerModal.style.display = 'none', 300);
            }
        }

        startScanBtn.addEventListener('click', async () => {
            const haUrl = localStorage.getItem('haUrl');
            const haToken = localStorage.getItem('haToken');
            const tuyaId = localStorage.getItem('tuyaClientId');

            if (!haUrl && !tuyaId) {
                alert("Veuillez configurer Home Assistant ou Tuya avant de scanner.");
                return;
            }

            scannerResults.innerHTML = '<p style="text-align: center; padding: 2rem;">Recherche en cours...</p>';
            startScanBtn.disabled = true;
            importBtn.style.display = 'none';
            scannedEntities = [];

            const scanPromises = [];

            // --- Home Assistant Scan ---
            if (haUrl && haToken) {
                scanPromises.push((async () => {
                    try {
                        const template = `
                            {%- set domains = ['light', 'switch', 'cover', 'climate', 'binary_sensor', 'sensor', 'camera'] -%}
                            {%- set ns = namespace(entities=[]) -%}
                            {%- for domain in domains -%}
                                {%- if states[domain] -%}
                                    {%- for state in states[domain] -%}
                                        {%- set area = area_name(state.entity_id) -%}
                                        {%- set _ = ns.entities.append({
                                            "entity_id": state.entity_id,
                                            "area_name": area if area else "",
                                            "friendly_name": state.name,
                                            "source": "ha"
                                        }) -%}
                                    {%- endfor -%}
                                {%- endif -%}
                            {%- endfor -%}
                            {{ ns.entities | tojson }}
                        `.trim();

                        const response = await fetch(`${haUrl}/api/template`, {
                            method: 'POST',
                            headers: { "Authorization": `Bearer ${haToken}`, "Content-Type": "application/json" },
                            body: JSON.stringify({ template })
                        });

                        if (response.ok) {
                            const results = await response.json();
                            console.log("HA Scan Results:", results);
                            scannedEntities.push(...results);
                        }
                    } catch (e) { console.error("HA Scan failed", e); }
                })());
            }

            // --- Tuya Scan ---
            if (tuyaId) {
                scanPromises.push((async () => {
                    try {
                        // 1. Get Token
                        const tokenRes = await fetch(`/api/tuya/token?userId=${window.nexuraUser?.id}`);
                        const tokenData = await tokenRes.json();

                        if (tokenData.success && tokenData.result) {
                            const accessToken = tokenData.result.access_token;

                            // 2. Get Devices
                            const proxyRes = await fetch('/api/tuya/proxy', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId: window.nexuraUser?.id,
                                    accessToken: accessToken,
                                    tuyaPath: `/v1.0/users/${tokenData.result.uid}/devices`,
                                    method: 'GET'
                                })
                            });

                            const devicesData = await proxyRes.json();
                            if (devicesData.success && devicesData.result) {
                                const tuyaItems = devicesData.result.map(d => ({
                                    entity_id: d.id,
                                    friendly_name: d.name,
                                    area_name: d.room_name || "",
                                    source: "tuya",
                                    category: d.category
                                }));
                                scannedEntities.push(...tuyaItems);
                            }
                        }
                    } catch (e) { console.error("Tuya Scan failed", e); }
                })());
            }

            try {
                await Promise.all(scanPromises);
                renderScannerResults();
                if (scannedEntities.length > 0) importBtn.style.display = 'block';
            } catch (err) {
                console.error("Scan error:", err);
                scannerResults.innerHTML = `<p style="text-align: center; color: #ef4444; padding: 2rem;">Erreur lors du scan.</p>`;
            } finally {
                startScanBtn.disabled = false;
                lucide.createIcons();
            }
        });

        // Search logic
        const scanSearchInput = document.getElementById('scanSearchInput');
        scanSearchInput.addEventListener('input', () => {
            renderScannerResults(scanSearchInput.value.toLowerCase());
        });

        function renderScannerResults(filter = '') {
            scannerResults.innerHTML = '';

            const filtered = scannedEntities.filter(e => {
                const searchStr = `${e.entity_id} ${e.friendly_name} ${e.area_name || ''} ${e.source || ''}`.toLowerCase();
                return searchStr.includes(filter);
            });

            if (filtered.length === 0) {
                scannerResults.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">${scannedEntities.length === 0 ? 'Appuyez sur "Lancer le scan".' : 'Aucun résultat correspondant.'}</p>`;
                return;
            }

            filtered.forEach(e => {
                let type = 'light';
                let domain = 'ha';

                if (e.source === 'tuya') {
                    domain = 'tuya';
                    // Tuya category mapping (simplified)
                    // https://developer.tuya.com/en/docs/iot/standard-description?id=K9i5ql3v98hn3
                    if (e.category === 'kg' || e.category === 'cz') type = 'switch';
                    else if (e.category === 'cl') type = 'shutter';
                    else if (e.category === 'ws') type = 'sensor';
                    else if (e.category === 'sp') type = 'camera';
                    else type = 'light';
                } else {
                    const haDomain = e.entity_id.split('.')[0];
                    if (haDomain === 'cover') type = 'shutter';
                    else if (haDomain === 'camera') type = 'camera';
                    else if (haDomain === 'image') type = 'camera';
                    else type = haDomain;
                }

                const friendlyName = e.friendly_name || e.entity_id;
                const area = e.area_name || null;
                const exists = entities.some(stored => stored.haId === e.entity_id);

                const item = document.createElement('label');
                item.className = 'scan-item';
                item.innerHTML = `
            <input type="checkbox" data-id="${e.entity_id}" data-name="${friendlyName}" data-type="${type}"
                data-area="${area || ''}" data-source="${domain}" ${exists ? 'disabled' : ''}>
            <div class="scan-item-info">
                <h4>
                    ${friendlyName} 
                    ${exists ? '<span style="color:var(--accent-color); font-size:0.7rem;">(Déjà ajouté)</span>' : ''}
                    <span style="font-size:0.65rem; padding: 2px 6px; border-radius: 4px; background: ${domain === 'tuya' ? '#FF5500' : '#03A9F4'}; color: white; margin-left: 8px;">
                        ${domain === 'tuya' ? 'TUYA' : 'HA'}
                    </span>
                </h4>
                <p>${e.entity_id} ${area ? `• <span style="color: var(--accent-color)">${area}</span>` : ''}</p>
            </div>
                `;
                scannerResults.appendChild(item);
            });
            lucide.createIcons();
        }

        importBtn.addEventListener('click', () => {
            const checkboxes = scannerResults.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                // Mark selected entities for easier processing
                const entityId = cb.dataset.id;
                const scannedEntity = scannedEntities.find(e => e.entity_id === entityId);
                if (scannedEntity) {
                    scannedEntity.selected = true;
                    scannedEntity.type = cb.dataset.type; // Ensure type is correctly mapped
                }
            });

            const selected = scannedEntities.filter(e => e.selected);
            if (selected.length === 0) return;

            let added = 0;
            selected.forEach(s => {
                if (!entities.some(e => e.haId === s.entity_id)) {
                    if (window.isFeatureAllowed('entities', entities.length)) {
                        // Create room if it's new
                        if (s.area_name) {
                            const roomId = slugify(s.area_name);
                            if (!rooms.some(r => r.id === roomId)) {
                                if (window.isFeatureAllowed('rooms', rooms.length)) {
                                    rooms.push({ id: roomId, name: s.area_name });
                                }
                            }
                            s.roomId = roomId;
                        }

                        entities.push({
                            name: s.friendly_name || s.entity_id,
                            type: s.type,
                            haId: s.entity_id,
                            roomId: s.roomId || null,
                            source: s.source || 'ha'
                        });
                        added++;
                    }
                }
            });

            if (added < selected.length) {
                alert(`Importation partielle: ${added} entités ajoutées. Le reste a été bloqué par les limites de votre plan Gratuit.`);
            }
            localStorage.setItem('domotique_rooms', JSON.stringify(rooms));
            localStorage.setItem('domotique_entities', JSON.stringify(entities));
            renderRooms();
            renderEntities();
            if (window.syncToCloud) window.syncToCloud();
            scannerModal.style.display = 'none';
        });

        // --- HA Help Modal ---
        function openHAHelpModal() {
            document.getElementById('haHelpModal').style.display = 'flex';
        }

        function closeHAHelpModal() {
            document.getElementById('haHelpModal').style.display = 'none';
        }
    </script>

    <!-- HA Help Modal -->
    <div class="modal-overlay" id="haHelpModal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2 style="font-size: 1.2rem; margin: 0;">Aide : Adresse Home Assistant</h2>
                <button onclick="closeHAHelpModal()"
                    style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body" style="line-height: 1.6; font-size: 0.9rem;">
                <div
                    style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; color: #f59e0b;">
                    <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                        <i data-lucide="alert-triangle" style="width: 20px; flex-shrink: 0;"></i>
                        <p style="margin: 0;">L'utilisation d'une adresse locale (<code>http://192.168.x.x</code>)
                            présente des défis techniques majeurs.</p>
                    </div>
                </div>

                <h4 style="color: var(--accent-color); margin-bottom: 0.5rem;">1. Problème de Contenu Mixte (HTTPS)</h4>
                <p>Nexura est sécurisé via HTTPS. Votre navigateur <b>bloquera</b> toute connexion vers une adresse non
                    sécurisée (HTTP).
                    Il est recommandé d'utiliser une URL HTTPS (via DuckDNS, Nabu Casa ou Cloudflare Tunnel).</p>

                <h4 style="color: var(--accent-color); margin: 1rem 0 0.5rem;">2. Configuration du CORS</h4>
                <p>Home Assistant bloque les requêtes externes par sécurité. Vous devez autoriser Nexura dans votre
                    <code>configuration.yaml</code> :
                </p>
                <pre
                    style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 8px; font-size: 0.8rem; margin: 0.5rem 0;">http:
  cors_allowed_origins:
    - https://nexura.pages.dev</pre>

                <h4 style="color: var(--accent-color); margin: 1rem 0 0.5rem;">3. Réseau Local</h4>
                <p>Si vous utilisez une adresse IP locale, votre appareil (tablette, smartphone) doit impérativement
                    être connecté au même réseau WiFi que Home Assistant.</p>
            </div>
            <div class="modal-footer">
                <button class="filter-btn active" onclick="closeHAHelpModal()">Compris</button>
            </div>
        </div>
    </div>

</body>

</html>